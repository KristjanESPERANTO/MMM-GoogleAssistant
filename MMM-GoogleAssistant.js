var _log=Function.prototype.bind.call(console.log,console,"[ASSISTANT]"),log=function(){};Module.register("MMM-GoogleAssistant",{requiresVersion:"2.14.0",defaults:{debug:!1,assistantConfig:{lang:"en-US",credentialPath:"credentials.json",tokenPath:"token.json",latitude:51.50853,longitude:-.076132},responseConfig:{useScreenOutput:!0,screenOutputCSS:"screen_output.css",screenOutputTimer:5e3,screenRotate:!1,activateDelay:250,useAudioOutput:!0,useChime:!0,newChime:!1,useNative:!1,playProgram:"mpg321"},micConfig:{recorder:"arecord",device:null},snowboy:{useSnowboy:!0,usePMDL:!1,PMDLPath:"../../../components",audioGain:2,Frontend:!0,Model:"jarvis",Sensitivity:null},A2DServer:{useA2D:!1,stopCommand:"stop",useYouTube:!1,youtubeCommand:"youtube",displayResponse:!0},recipes:[],NPMCheck:{useChecker:!0,delay:6e5,useAlert:!0}},plugins:{onReady:[],onNotificationReceived:[],onActivate:[],onStatus:[]},commands:{},transcriptionHooks:{},responseHooks:{},forceResponse:!1,getScripts:function(){return["/modules/MMM-GoogleAssistant/components/response.js"]},getStyles:function(){return["/modules/MMM-GoogleAssistant/MMM-GoogleAssistant.css"]},getTranslations:function(){return{en:"translations/en.json",fr:"translations/fr.json",it:"translations/it.json",de:"translations/de.json"}},start:function(){const s=["debug","dev","recipes","assistantConfig","micConfig","responseConfig","A2DServer","snowboy","NPMCheck"];this.helperConfig={},this.config.debug&&(log=_log),this.config=this.configAssignment({},this.defaults,this.config);for(var t=0;t<s.length;t++)this.helperConfig[s[t]]=this.config[s[t]];this.myStatus={actual:"standby",old:"standby"};var e={assistantActivate:s=>{this.assistantActivate(s)},postProcess:(s,t,e)=>{this.postProcess(s,t,e)},endResponse:()=>{this.endResponse()},sendNotification:(s,t=null)=>{this.sendNotification(s,t)},sendSocketNotification:(s,t=null)=>{this.sendSocketNotification(s,t)},translate:s=>this.translate(s),myStatus:s=>{this.doPlugin("onStatus",{status:s}),this.myStatus=s},A2D:s=>{if(this.config.A2DServer.useA2D)return this.Assistant2Display(s)},sendAudio:s=>{this.sendSocketNotification("PLAY_AUDIO",s)},sendChime:s=>{this.sendSocketNotification("PLAY_CHIME",s)}};if(this.assistantResponse=new AssistantResponse(this.helperConfig.responseConfig,e),this.config.A2DServer.useA2D&&this.config.A2DServer.useYouTube){var o={transcriptionHooks:{SEARCH_YouTube:{pattern:this.config.A2DServer.youtubeCommand+" (.*)",command:"youtube"}},commands:{youtube:{moduleExec:{module:["MMM-GoogleAssistant"],exec:"__FUNC__(module, params) => { module.sendSocketNotification('YouTube_SEARCH', params[1]) }"},soundExec:{chime:"open"},displayResponse:this.config.A2DServer.displayResponse}}};this.parseLoadedRecipe(JSON.stringify(o))}},doPlugin:function(s,t){if(this.plugins.hasOwnProperty(s)){var e=this.plugins[s];if(Array.isArray(e)&&e.length>0)for(var o=0;o<e.length;o++){var n=e[o];this.doCommand(n,t,s)}}},registerPluginsObject:function(s){for(var t in this.plugins)if(s.hasOwnProperty(t)){var e=[];Array.isArray(s[t])?e=e.concat(s[t]):e.push(s[t].toString());for(var o=0;o<e.length;o++)this.registerPlugin(t,e[o])}},registerPlugin:function(s,t){this.plugins.hasOwnProperty(s)&&(Array.isArray(t)&&this.plugins[s].concat(t),this.plugins[s].push(t))},registerCommandsObject:function(s){this.commands=Object.assign({},this.commands,s)},registerTranscriptionHooksObject:function(s){this.transcriptionHooks=Object.assign({},this.transcriptionHooks,s)},registerResponseHooksObject:function(s){this.responseHooks=Object.assign({},this.responseHooks,s)},configAssignment:function(s){for(var t,e,o=Array.prototype.slice.call(arguments,1);o.length;)for(e in t=o.shift())t.hasOwnProperty(e)&&("object"==typeof s[e]&&s[e]&&"[object Array]"!==Object.prototype.toString.call(s[e])&&"object"==typeof t[e]&&null!==t[e]?s[e]=this.configAssignment({},s[e],t[e]):s[e]=t[e]);return s},getDom:function(){this.assistantResponse.modulePosition();var s=document.createElement("div");return s.id="GA_DOM",MM.getModules().withClass("MMM-GoogleAssistant").enumerate(s=>{s.hide(0,{lockString:"GA_LOCKED"})}),s},notificationReceived:function(s,t=null,e=null){switch(this.doPlugin("onNotificationReceived",{notification:s,payload:t}),s){case"DOM_OBJECTS_CREATED":this.sendSocketNotification("INIT",this.helperConfig),this.assistantResponse.prepare();break;case"ASSISTANT_WELCOME":this.assistantActivate({type:"TEXT",key:t.key,chime:!1},Date.now());break;case"ASSISTANT_START":this.config.snowboy.useSnowboy&&this.sendSocketNotification("ASSISTANT_READY");break;case"ASSISTANT_STOP":this.config.snowboy.useSnowboy&&this.sendSocketNotification("ASSISTANT_BUSY");break;case"GA_ACTIVATE":this.config.snowboy.useSnowboy||this.assistantActivate({type:"MIC"})}},socketNotificationReceived:function(s,t){switch(s){case"NPM_UPDATE":t&&t.length>0&&(this.config.NPMCheck.useAlert&&t.forEach(s=>{this.sendNotification("SHOW_ALERT",{type:"notification",message:"[NPM] "+s.library+" v"+s.installed+" -> v"+s.latest,title:this.translate("UPDATE_NOTIFICATION_MODULE",{MODULE_NAME:s.module}),timer:this.config.NPMCheck.delay-2e3})}),this.sendNotification("NPM_UPDATE",t));break;case"LOAD_RECIPE":this.parseLoadedRecipe(t);break;case"NOT_INITIALIZED":this.assistantResponse.fullscreen(!0),this.assistantResponse.showError(t);break;case"INITIALIZED":log("Initialized."),this.assistantResponse.status("standby"),this.sendSocketNotification("ASSISTANT_READY"),this.doPlugin("onReady"),this.config.A2DServer.useA2D&&this.sendNotification("ASSISTANT_READY");break;case"ASSISTANT_RESULT":null!==t.volume&&this.sendNotification("A2D_VOLUME",t.volume),this.assistantResponse.start(t);break;case"TUNNEL":this.assistantResponse.tunnel(t);break;case"ASSISTANT_ACTIVATE":this.assistantActivate(t);break;case"AUDIO_END":this.assistantResponse.end();break;case"YouTube_RESULT":this.sendYouTubeResult(t)}},parseLoadedRecipe:function(payload){let reviver=(key,value)=>{if("string"==typeof value&&0===value.indexOf("__FUNC__")){value=value.slice(8);let functionTemplate=`(${value})`;return eval(functionTemplate)}return value};var p=JSON.parse(payload,reviver);p.hasOwnProperty("commands")&&this.registerCommandsObject(p.commands),p.hasOwnProperty("transcriptionHooks")&&this.registerTranscriptionHooksObject(p.transcriptionHooks),p.hasOwnProperty("responseHooks")&&this.registerResponseHooksObject(p.responseHooks),p.hasOwnProperty("plugins")&&this.registerPluginsObject(p.plugins)},assistantActivate:function(s){if("standby"!=this.myStatus.actual&&!s.force)return log("Assistant is busy.");this.doPlugin("onActivate"),this.assistantResponse.fullscreen(!0),this.config.A2DServer.useA2D&&this.sendNotification("A2D_ASSISTANT_BUSY"),this.sendSocketNotification("ASSISTANT_BUSY"),this.lastQuery=null;var t={type:"TEXT",key:null,lang:this.config.assistantConfig.lang,useScreenOutput:this.config.responseConfig.useScreenOutput,useAudioOutput:this.config.responseConfig.useAudioOutput,status:this.myStatus.old,chime:!0};t=Object.assign({},t,s);setTimeout(()=>{this.assistantResponse.status(t.type,!!t.chime),this.sendSocketNotification("ACTIVATE_ASSISTANT",t)},this.config.responseConfig.activateDelay)},endResponse:function(){this.config.A2DServer.useA2D&&this.sendNotification("A2D_ASSISTANT_READY"),this.sendSocketNotification("ASSISTANT_READY"),this.config.snowboy.useSnowboy||this.sendNotification("SNOWBOY_START")},postProcess:function(s,t=(()=>{}),e=(()=>{})){if("continue"==s.lastQuery.status)return e();var o=this.findAllHooks(s);if(o.length>0){this.assistantResponse.status("hook");for(var n=0;n<o.length;n++){var i=o[n];this.doCommand(i.command,i.params,i.from)}t()}else e()},findAllHooks:function(s){var t=[];return t=(t=t.concat(this.findTranscriptionHook(s))).concat(this.findResponseHook(s)),this.findNativeAction(s),t},findResponseHook:function(s){var t=[];if(s.screen){var e=[];for(var o in e.links=s.screen.links?s.screen.links:[],e.text=s.screen.text?[].push(s.screen.text):[],e.photos=s.screen.photos?s.screen.photos:[],this.responseHooks)if(this.responseHooks.hasOwnProperty(o)){var n=this.responseHooks[o];if(n.where&&n.pattern&&n.command){var i=new RegExp(n.pattern,"ig").exec(e[n.where]);i&&(t.push({from:o,params:i,command:n.command}),log("ResponseHook matched:",o))}}}return t},findTranscriptionHook:function(s){var t=[],e=s.transcription?s.transcription.transcription:"";for(var o in this.transcriptionHooks)if(this.transcriptionHooks.hasOwnProperty(o)){var n=this.transcriptionHooks[o];if(n.pattern&&n.command){var i=new RegExp(n.pattern,"ig").exec(e);i&&(t.push({from:o,params:i,command:n.command}),log("TranscriptionHook matched:",o))}else log(`TranscriptionHook:${o} has invalid format`)}return t},findNativeAction:function(s){var t=s.action?s.action:null;t&&t.inputs&&t.inputs.forEach(s=>{"action.devices.EXECUTE"==s.intent&&s.payload.commands.forEach(s=>{s.execution.forEach(s=>{log("Native Action: "+s.command,s.params),"action.devices.commands.SetVolume"==s.command&&(log("Volume Control:",s.params.volumeLevel),this.sendNotification("A2D_VOLUME",s.params.volumeLevel))})})})},doCommand:function(s,t,e){if(this.assistantResponse.doCommand(s,t,e),this.commands.hasOwnProperty(s)){var o=this.commands[s];o.displayResponse&&(this.forceResponse=!0);var n="object"==typeof t?Object.assign({},t):t;if(o.hasOwnProperty("notificationExec")){var i=o.notificationExec;if(i.notification){var a="function"==typeof i.notification?i.notification(n,e):i.notification,r=i.payload?"function"==typeof i.payload?i.payload(n,e):i.payload:null,c="object"==typeof r?Object.assign({},r):r;log(`Command ${s} is executed (notificationExec).`),this.sendNotification(a,c)}}if(o.hasOwnProperty("shellExec")){var u=o.shellExec;if(u.exec){var l="function"==typeof u.exec?u.exec(n,e):u.exec,p=u.options?"function"==typeof u.options?u.options(n,e):u.options:null,h="function"==typeof p?p(n,key):p;log(`Command ${s} is executed (shellExec).`),this.sendSocketNotification("SHELLEXEC",{command:l,options:h})}}if(o.hasOwnProperty("moduleExec")){var f=o.moduleExec,d="function"==typeof f.module?f.module(n,e):f.module,m=Array.isArray(d)?d:new Array(d);"function"==typeof f.exec&&MM.getModules().enumerate(t=>{(0==m.length||m.indexOf(t.name)>=0)&&(log(`Command ${s} is executed (moduleExec) for :`,t.name),f.exec(t,n,e))})}if(o.hasOwnProperty("functionExec")){var g=o.functionExec;"function"==typeof g.exec&&(log(`Command ${s} is executed (functionExec)`),g.exec(n,e))}if(o.hasOwnProperty("soundExec")){var A=o.soundExec;A.chime&&"string"==typeof A.chime&&("open"==A.chime&&this.assistantResponse.playChime("open"),"close"==A.chime&&this.assistantResponse.playChime("close")),A.sound&&"string"==typeof A.sound&&this.assistantResponse.playChime(A.sound,!0)}}else log(`Command ${s} is not found.`)},Assistant2Display:function(s){if(s.transcription&&s.transcription.transcription==this.config.A2DServer.stopCommand)return this.sendNotification("A2D_STOP");var t={from:"GA",photos:null,urls:null,transcription:null};s.screen&&(s.screen.links.length>0||s.screen.photos.length>0)&&(t.photos=s.screen.photos,t.urls=s.screen.links,t.transcription=s.transcription,log("Send A2D Response."),this.sendNotification("A2D",t))},sendYouTubeResult:function(s){var t={from:"GA",photos:[],urls:["https://www.youtube.com/watch?v="+s],transcription:{transcription:"Youtube Search...",done:"false"}};log("Send YouTube Response to A2D."),this.sendNotification("A2D",t)}});
